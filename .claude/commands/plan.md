# Plan フェーズ

## 目的
UCHosのマイクロカーネル設計に基づいた実装方針の決定、タスク分解、ファイル変更計画、テスト方針を策定する。

## 必要な入力ファイル
- `docs/analysis/analyze_{TIMESTAMP}.md` - 調査結果

## 注意事項
- 関連するコードは全て読むこと（特にkernel/, userland/, libs/ディレクトリ）
- 全ての処理においてultrathinkでしっかりと考えて作業を行うこと
- マイクロカーネルの原則「とにかくシンプルに」を常に意識すること
- システムコールの追加は最小限に抑えること
- カーネル機能は本当に必要な場合のみ実装すること

# ユーザの入力
#$ARGUMENTS

## UCHos設計原則の確認
1. **カーネル/ユーザーランド判断基準**
   - カーネル実装：メモリ管理、プロセス管理、IPC、割り込み、基本的なデバイスドライバのみ
   - ユーザーランド実装：それ以外の全ての機能

2. **既存サブシステムとの統合**
   - メモリ管理（Buddy System、Slab Allocator）
   - タスク管理（ラウンドロビンスケジューラ）
   - ファイルシステム（FAT64）
   - デバイスドライバ（VirtIO、XHCI）

## テスト方針
- **カーネル内部テスト**: kernel/tests/フレームワークを使用（ASSERT_*, EXPECT_*マクロ）
- **ユーザーランドテスト**: 各コマンドのMakefileでテストビルド
- **統合テスト**: QEMUでの実機動作確認
- **コード品質**: ./lint.sh（clang-tidy）の実行必須

## タスクに含まれるべきTODO
1. ユーザの指示を理解する
2. 最新の `docs/analysis/analyze_{TIMESTAMP}.md` を読み込み、調査結果を確認
3. UCHosの設計原則に基づいて実装方針を決定
   - カーネル実装が必要か、ユーザーランド実装で十分か
   - 既存システムコールで対応可能か、新規追加が必要か
   - 既存サブシステムの拡張で対応可能か
4. 詳細実装タスクを分解し、優先度を設定
   - カーネル側の変更
   - ユーザーランド側の変更
   - テストの実装
5. ファイル変更計画を作成（新規作成・修正・削除）
   - 既存ファイルの編集を優先
   - 新規ファイル作成は最小限に
6. テスト戦略を策定
   - kernel/tests/でのテストケース追加
   - ユーザーランドでのテスト方法
7. リスク分析と対策を検討
   - カーネルパニックのリスク
   - メモリリークのリスク
   - パフォーマンス劣化のリスク
8. 実装計画を文書化し、`docs/plan/plan_{TIMESTAMP}.md`に保存
9. プラン完成をユーザに通知

## 実装計画ドキュメントテンプレート
```markdown
# Implementation Plan: [機能名]

## 概要
[実装する機能の概要と目的]

## 調査結果サマリー
[analysis結果の要約]

## 実装方針
### アーキテクチャ決定
- [ ] カーネル実装 / [ ] ユーザーランド実装
- 理由: [決定理由]

### システムコール
- 既存利用: [利用するシステムコール]
- 新規追加: [追加が必要なシステムコール（最小限）]

## 実装タスク
### Phase 1: 基本実装
1. [ ] [タスク1] - [ファイル名:行番号]
2. [ ] [タスク2] - [ファイル名:行番号]

### Phase 2: テスト実装
1. [ ] カーネルテスト追加 - kernel/tests/test_cases/

### Phase 3: 統合・最適化
1. [ ] パフォーマンス最適化
2. [ ] ドキュメント更新

## ファイル変更計画
### 修正ファイル
| ファイル | 変更内容 | 理由 |
|----------|----------|------|
| [ファイルパス] | [変更内容] | [理由] |

### 新規ファイル（最小限）
| ファイル | 目的 | 配置理由 |
|----------|------|----------|
| [ファイルパス] | [目的] | [なぜ既存ファイルで対応できないか] |

## テスト計画
### カーネルテスト
```cpp
// kernel/tests/test_cases/[新規テストファイル名].cpp
void register_[機能名]_tests() {
    test_register("test_[基本機能]", test_[基本機能]_function);
    test_register("test_[エラーケース]", test_[エラーケース]_function);
}
```

## リスク管理
| リスク | 影響度 | 軽減策 |
|--------|--------|--------|
| [リスク] | 高/中/低 | [対策] |

## 実装順序
1. [タスク]
2. [タスク]

## 成功基準
- [ ] 全テストケースの合格
- [ ] ./lint.sh でエラー・警告なし
```

## 出力ファイル
- `docs/plan/plan_{TIMESTAMP}.md`

## 最終出力形式
- 必ず以下の二つの形式で出力を行ってください

### プラン策定完了の場合
status: SUCCESS
next: IMPLEMENT
details: "UCHosマイクロカーネル設計に基づく実装プラン策定完了。plan_{TIMESTAMP}.mdに詳細記録。実装フェーズに移行。"

### 調査不足の場合
status: NEED_MORE_INFO
next: INVESTIGATE
details: "情報不足。plan_{TIMESTAMP}.mdに詳細記録。追加調査が必要。"