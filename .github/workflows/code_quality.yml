name: UCHos Code Quality & Naming Convention Check

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  code_quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-18 \
          clang-tidy-18 \
          clang-format-18 \
          cmake \
          build-essential \
          lld-18
    
    - name: Setup build environment
      run: |
        # CMakeæ§‹æˆ
        cmake -B build kernel
        
    - name: Build UCHos kernel
      run: |
        cmake --build build
        
    - name: Run comprehensive naming convention check
      run: |
        echo "=== Google C++ Style Guideæº–æ‹  åŒ…æ‹¬çš„å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯ ==="
        ./scripts/check_naming_full.sh
        
    - name: Run clang-tidy static analysis
      run: |
        run-clang-tidy -p build \
          -clang-tidy-binary "clang-tidy-18" \
          -header-filter='^(?!.*/x86_64-elf/).*' \
          -quiet
          
    - name: Check clang-format compliance
      run: |
        # å…¨CPPãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
        find kernel/ libs/ userland/ -name "*.cpp" -o -name "*.hpp" | \
        xargs clang-format-18 --dry-run --Werror
        
    - name: Run integrated code quality check
      run: |
        echo "=== çµ±åˆã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ ==="
        ./lint.sh
        
  naming_regression_test:
    runs-on: ubuntu-latest
    needs: code_quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify Google C++ Style Guide compliance
      run: |
        echo "=== Google C++ Style Guideæº–æ‹ ãƒã‚§ãƒƒã‚¯ ==="
        
        # Phase5å®Œäº†ç¢ºèª: PascalCaseå‹ã®å­˜åœ¨ç¢ºèª
        echo "Phase5 ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢é–¢é€£å‹ã®PascalCaseç¢ºèª:"
        
        # é‡è¦ãªPascalCaseå‹ã®å­˜åœ¨ç¢ºèª
        expected_types=(
          "Device" "ClassDriver" "Controller" "DeviceManager"
          "VirtqDesc" "VirtioBlkReq" "EndpointDescriptor" "EndpointConfig"
          "CapabilityRegisters" "OperationalRegisters" "MemoryMappedRegister"
        )
        
        missing_types=0
        for type_name in "${expected_types[@]}"; do
          if ! grep -r "struct\|class" kernel/hardware/ | grep -q "$type_name"; then
            echo "âŒ å‹ '$type_name' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            ((missing_types++))
          else
            echo "âœ… å‹ '$type_name' ç¢ºèª"
          fi
        done
        
        if [ $missing_types -eq 0 ]; then
          echo "ğŸ‰ å…¨ã¦ã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢é–¢é€£å‹ãŒPascalCaseåŒ–ã•ã‚Œã¦ã„ã¾ã™"
        else
          echo "âš ï¸  $missing_types å€‹ã®å‹ã§PascalCaseåŒ–ãŒæœªå®Œäº†ã§ã™"
          exit 1
        fi
        
        echo ""
        echo "=== æŠ€è¡“çš„æ³¨è¨˜ ==="
        echo "C++æ¨™æº–ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿è¦ä»¶ã«ã‚ˆã‚Šã€rebindæ§‹é€ ä½“ã¯ä¾‹å¤–çš„ã«å°æ–‡å­—ã§ç¶­æŒã•ã‚Œã¾ã™ã€‚"
        echo "ã“ã‚Œã¯æŠ€è¡“çš„ã«æ­£å½“åŒ–ã•ã‚ŒãŸä¾‹å¤–ã§ã™ã€‚"
        
    - name: Check for snake_case type violations
      run: |
        echo "=== snake_caseå‹é•åãƒã‚§ãƒƒã‚¯ ==="
        
        # ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢é–¢é€£ã§snake_caseå‹ãŒæ®‹ã£ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆrebindé™¤å¤–ï¼‰
        violations_files=$(find kernel/hardware/ -name "*.hpp" -exec grep -l "struct [a-z_]" {} \; 2>/dev/null || true)
        
        # rebindã‚’å«ã¾ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
        actual_violations=0
        if [ -n "$violations_files" ]; then
          for file in $violations_files; do
            if ! grep -q "struct rebind" "$file" 2>/dev/null; then
              ((actual_violations++))
            fi
          done
        fi
        
        if [ $actual_violations -eq 0 ]; then
          echo "âœ… snake_caseå‹é•åã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆC++æ¨™æº–è¦ä»¶rebindã¯é™¤å¤–ï¼‰"
        else
          echo "âŒ $actual_violations å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§snake_caseå‹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          # rebindã‚’é™¤å¤–ã—ã¦é•åã‚’è¡¨ç¤º
          find kernel/hardware/ -name "*.hpp" -exec grep -n "struct [a-z_]" {} + 2>/dev/null | \
            grep -v "struct rebind" || true
          exit 1
        fi
